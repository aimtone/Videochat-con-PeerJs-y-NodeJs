<!doctype html>
<html lang="en" oncontextmenu="">

<head>
    <title>Hello, world!</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://rawgit.com/utatti/perfect-scrollbar/master/css/perfect-scrollbar.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic.css" rel="stylesheet">

    <style>
        * {
            cursor: default;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #content-wrap {
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #content-wrap #user-section {
            border-right: 1px solid #ccc;
            border-top: 1px solid #ccc;
            height: 100%;
            overflow: hidden;
            padding-bottom: 50px;
        }

        #content-wrap #user-section .user {
            border-bottom: 1px solid #ccc;
            padding: 5px 5px 5px 5px;
            margin: 0px -15px 0px -15px;
        }

        #content-wrap #user-section .user:hover {
            background: #f8f9fa !important;
        }

        #content-wrap #chatbox-section {
            border-right: 1px solid #ccc;
            border-top: 1px solid #ccc;
            height: 100%;
        }

        #content-wrap #chatbox-section #chat-section {
            height: 100%;
            width: 100%;
            position: absolute;
        }

        #message-box {
            overflow: hidden !important;
            min-height: 70%;
            max-height: 70%;
            height: 70%;
            width: 100%;
            top: 88px;
            left: 0px;
            position: absolute;
            padding: 10px 10px 20px 10px;
        }

        #content-wrap #chatbox-section #messages-section div {
            clear: both;
            background: #f8f9fa;
            float: left;
            max-width: 80%;
            min-width: 20%;
            text-align: left;
            word-wrap: break-word;
            margin-top: 10px;
            padding: 5px 5px 5px 5px;
        }

        #content-wrap #chatbox-section #messages-section div.me {
            background: #17a2b8;
            float: right;
            text-align: right;
            color: white;
            border: 1px solid #17a2b8 !important;
        }

        #content-wrap #chatbox-section #textarea-section {
            min-height: 10%;
            max-height: 10%;
            height: 10%;
            width: 100%;
            bottom: 45px;
            left: 0px;
            position: absolute;
            border-top: 1px solid #ccc;
        }

        #content-wrap #chatbox-section #textarea-section textarea {
            outline: none !important;
            box-shadow: none;
            border: none;
            resize: none;
            overflow: hidden !important;
        }

        #content-wrap #camera-section {
            border-top: 1px solid #ccc;
            height: 100%;
        }

        .active {
            background: #f8f9fa !important;
        }

        .aquamarine {
            background: #17a2b8 !important;
            color: white !important;
        }

        .aquamarine a,
        .aquamarine div a {
            color: white !important;
        }

        .aquamarine .dropdown-item {
            color: black !important;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light aquamarine">
        <a class="navbar-brand" href="#">VideoChat
            <span id="pid"></span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false">
                        Acciones
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">Desconectarme</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">Cerrar sesion</a>
                    </div>
                </li>

            </ul>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row" id="content-wrap">


            <div class="col col-sm-12 col-md-12 col-lg-3" id="user-section"></div>

            <div class="col col-lg-6 bg-light d-none" id="chatbox-section">
                <div class="row">
                    <div class="card border-light mb-3" id="chat-section">
                        <div class="card-header">
                            <div class="row">
                                <div class="col col-sm-6 text-header"></div>
                                <div class="col col-sm-6 text-right">
                                    <button id="call" type="button" class="btn btn-primary btn-sm ">
                                        <span class="oi" data-glyph="phone"></span>
                                    </button>
                                    <button disabled="disabled" id="hangup" type="button" class="btn btn-primary btn-sm">
                                        Colgar
                                    </button>
                                    <button type="button" id="toggleInfo" data-toggle="button" aria-pressed="false" class="btn btn-primary btn-sm ">
                                        <span class="oi" data-glyph="eye"></span>
                                    </button>
                                </div>
                            </div>




                        </div>
                        <div class="card-body">
                            <div id="message-box" class="card-text">
                                <div id="messages-section"></div>
                            </div>

                            <div id="textarea-section">
                                <form id="send">
                                    <div class="row">
                                        <div class="col col-sm-10">
                                            <textarea placeholder="Escriba su texto aqui" class="form-control" id="message-text"></textarea>
                                        </div>
                                        <div class="col col-sm-2">
                                            <button type="submit" class="btn btn-primary btn-sm ">Enviar</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col col-lg-3 d-none" id="camera-section">
                <div class="row">

                    <div id="camera" class="d-none">
                        <div class="card col col-sm-12">
                            <video id="peer-camera" width="100%" autoplay="autoplay" class="center-block"></video>
                            <h6 id="user-camera">Anthony Medina</h6>
                        </div>
                        <div class="card col col-sm-12">
                            <video id="my-camera" width="100%" autoplay="autoplay" muted="true" class="center-block"></video>
                            <h6>Yo</h6>
                        </div>
                    </div>

                    <div id="info" class="col col-sm-12 col-md-12 col-lg-12 text-center">
                        <br>
                        <img id="info-image" width="150" height="150" class=" img-fluid rounded-circle border border-secondary" src="" alt="Card image cap">
                        <div class="card-body">
                            <h4 class="card-title" id="info-name"></h4>
                            <p class="card-text" id="info-username"></p>
                        </div>

                    </div>




                </div>
            </div>

        </div>

    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>
    <script src="https://rawgit.com/utatti/perfect-scrollbar/master/dist/perfect-scrollbar.js"></script>
    <script src="resources/js/peer.min.js"></script>

    <script>
        var db = {
            users: [{
                    id: 1,
                    username: "anthony",
                    nombre: "Anthony",
                    apellido: "Medina",
                    imagen: "http://www.tuestima.com/wp-content/uploads/2015/11/Entrevista-Dr-Nicholas-Perricone.jpg"
                },
                {
                    id: 2,
                    username: "juan",
                    nombre: "Juan",
                    apellido: "Sanchez",
                    imagen: "https://labs.openviewpartners.com/wp-content/uploads/2016/02/Mike-King-300x300.png"
                },
                {
                    id: 3,
                    username: "pedro",
                    nombre: "Pedro",
                    apellido: "Perez",
                    imagen: "http://www.hemorroidestratamientoycura.com/wp-content/uploads/2012/10/doctor.png"
                }
            ],
            connections: [{
                    id: 1,
                    peers: ["anthony", "juan"]
                },
                {
                    id: 2,
                    peers: ["anthony", "pedro"]
                },
                {
                    id: 3,
                    peers: ["pedro", "juan"]
                }
            ],
            conversations: [{
                    id: 1,
                    connections_id: 1,
                    messages: []
                },
                {
                    id: 2,
                    connections_id: 2,
                    messages: []
                },
                {
                    id: 3,
                    connections_id: 3,
                    messages: []
                }
            ]

        };



        var encontrar = find(db.users, "username", "juan");
        console.log("valor encontrado");
        console.log(encontrar);




        new PerfectScrollbar('#message-box');
        new PerfectScrollbar('#user-section');
        var toggle = false;

        $(function () {



            $('#toggleInfo').click(function () {
                if (toggle) {
                    $("#camera-section").animate({
                        left: "-=350",
                        width: "toggle"
                    }, 100, function () {
                        toggle = false;
                        $('#chatbox-section').removeClass('col-lg-9');
                        $('#chatbox-section').addClass('col-lg-6');
                    });
                } else {
                    $("#camera-section").animate({
                        left: "+=350",
                        width: "toggle"
                    }, 100, function () {
                        toggle = true;
                        $('#chatbox-section').removeClass('col-lg-6');
                        $('#chatbox-section').addClass('col-lg-9');
                    });
                }

            });


            var username = prompt("Introduce tu nombre de usuario", "");

            // Cargar las conversaciones
            $.each(db.connections, function (key, value) {
                $.each(value.peers, function (key1, value1) {
                    if (value1 == username) {
                        $.each(value.peers, function (key2, value2) {
                            if (value2 != username) {
                                var id_conversation = value.id;
                                $.each(db.users, function (key3, value3) {

                                    if (value3.username == value2) {
                                        $("#user-section").append("<div id='" +
                                            value3.username +
                                            "' class='media user " +
                                            id_conversation +
                                            "'> <img class='mr-3 rounded-circle' width='64' height='64' src='" +
                                            value3.imagen +
                                            "' alt='Generic placeholder image'> <div class='media-body'> <h5 class='mt-0'>" +
                                            value3.nombre + " " + value3.apellido +
                                            " <small>(" + value3.username +
                                            ")</small> </h5> <span id='last_message'></span> </div><button type='button' class='close' aria-label='Close'> <span aria-hidden='true'>&times;</span> </button> </div>"
                                        );
                                    }
                                });


                            }
                        });
                    }
                });

            });


            var connectedPeers = {};

            var peer = new Peer(username, {
                host: "192.168.0.178",
                port: 9000,
                path: '/peerjs',
                debug: 3,
                config: {
                    'iceServers': [{
                            url: 'stun:stun1.l.google.com:19302'
                        },
                        {
                            url: 'turn:numb.viagenie.ca',
                            credential: 'muazkh',
                            username: 'webrtc@live.com'
                        }
                    ]
                }
            });


            // Este evento se ejecuta al conectar al usuario al servidor de PeerJS
            peer.on('open', function (id) {
                $('#pid').html(id);
            });

            // Este evento se ejecuta cuando ocurra un error al conectarse al servidor de PeerJS
            peer.on('error', function (err) {
                switch (err.type) {
                    case 'browser-incompatible':
                        console.log(
                            "browser-incompatible: The client's browser does not support some or all WebRTC features that you are trying to use."
                        );
                        break;
                    case 'disconnected':
                        console.log(
                            "disconnected: You've already disconnected this peer from the server and can no longer make any new connections on it."
                        );
                        break;
                    case 'invalid-id':
                        console.log(
                            "invalid-id: The ID passed into the Peer constructor contains illegal characters."
                        );
                        break;
                    case 'invalid-key':
                        console.log(
                            "invalid-key: The API key passed into the Peer constructor contains illegal characters or is not in the system (cloud server only)."
                        );
                        break;
                    case 'network':
                        console.log(
                            "network: Lost or cannot establish a connection to the signalling server."
                        );
                        break;
                    case 'peer-unavailable':
                        console.log(
                            "peer-unavailable: The peer you're trying to connect to does not exist."
                        );
                        $('.text-header small').html("Desconectado");
                        break;
                    case 'ssl-unavailable':
                        console.log(
                            "ssl-unavailable: PeerJS is being used securely, but the cloud server does not support SSL. Use a custom PeerServer."
                        );
                        break;
                    case 'server-error':
                        console.log("server-error: Unable to reach the server.");
                        break;
                    case 'socket-error':
                        console.log("socket-error: An error from the underlying socket.");
                        break;
                    case 'socket-closed':
                        console.log("socket-closed: The underlying socket closed unexpectedly.");
                        break;
                    case 'unavailable-id':
                        console.log(
                            "unavailable-id: The ID passed into the Peer constructor is already taken."
                        );
                        break;
                    case 'webrtc':
                        console.log("webrtc: Native WebRTC errors.");
                        break;
                    default:
                        console.log("An unexpected error has ocurred");
                        break;
                }
            });

            // Este evento se ejecuta al detectar la llamada de un usuario
            peer.on('call', function (call) {
                console.log(call);
                var acceptsCall = confirm("Videollamada entrante, desea responder?");
                if (acceptsCall) {
                    call.answer(window.localStream);
                    // Recibir data
                    call.on('stream', function (stream) {
                        // Guardar un referencia global de la informacion transmitida
                        window.peer_stream = stream;
                        // Muestra la trasmision del usuario conectado en mi camara
                        onReceiveStream(stream, 'peer-camera');
                        $('#camera').removeClass('d-none');
                        $('#info').addClass('d-none');
                        $("#hangup").prop("disabled", false);
                        $("#call").prop("disabled", true);
                        
                    });
                    // Se ejecuta cuando la llamada finaliza
                    call.on('close', function () {
                        $('#camera').addClass('d-none');
                        $('#info').removeClass('d-none');
                    });
                } else {
                    console.log("Call denied !");
                }
            });


            // Este evento se ejecuta cuando se detecta una nueva conexion con un usuario
            peer.on('connection', connect);

            // Esta funcion se ejecuta cuando un usuario conecta con otro, y se dispara en el evento 'connection'
            function connect(c) {



                if (c.label === 'chat') {


                    c.on('data', function (data) {
                        $.each(db.conversations, function (key, value) {
                            if (value.connections_id == c.metadata.conversation_id) {
                                var obj = {
                                    from: c.peer,
                                    message: data
                                };
                                db.conversations[key].messages.push(obj);
                            }
                        });

                        $('#' + c.peer + " span#last_message").html(data);

                        if (typeof $('.active')["0"].id !== "undefined") {
                            if ($('.active')["0"].id == c.peer) {
                                $('#messages-section').append(
                                    "<div class='border border-secondary rounded'>" +
                                    data + "</div>");
                            }
                        }



                    });

                    c.on('close', function () {
                        $('#' + c.peer + " span#last_message").html("Desconectado");
                        delete connectedPeers[c.peer];
                    });
                } else if (c.label === 'file') {
                    c.on('data', function (data) {


                        if (data.constructor === ArrayBuffer) {
                            var dataView = new Uint8Array(data);
                            var dataBlob = new Blob([dataView]);

                            var url = window.URL.createObjectURL(dataBlob);
                            $('#' + c.peer + " span#last_message").html(c.peer +
                                " te ha enviado un <a href='" + url + "'>archivo</a>");

                        }
                    });
                }
                connectedPeers[c.peer] = 1;
            }



            var box = $('#message-box');
            box.on('dragenter', doNothing);
            box.on('dragover', doNothing);
            box.on('drop', function (e) {
                e.originalEvent.preventDefault();
                var file = e.originalEvent.dataTransfer.files[0];
                eachActiveConnection(function (c, $c) {
                    if (c.label === 'file') {
                        c.send(file);
                        console.log(file);
                        $('#messages-section').append(
                            "<div class='border border-secondary rounded me'>" + file.name +
                            " (" + file.size + " bytes)</div>");
                    }
                });
            });

            // Funcion nula
            function doNothing(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Esta funcion se ejecuta al hacer clic sobre el boton 'conectar'

            $('.user').click(function (e) {
                var conversation_id = e.currentTarget.classList[2];
                var requestedPeer = e.currentTarget.id;
                $('.user').removeClass('active');
                $('#' + requestedPeer).addClass('active');
                if (!connectedPeers[requestedPeer]) {
                    var c = peer.connect(requestedPeer, {
                        label: 'chat',
                        serialization: 'none',
                        metadata: {
                            conversation_id: conversation_id,
                            requestedPeer: requestedPeer
                        }
                    });
                    c.on('open', function () {
                        connect(c);
                    });
                    c.on('error', function (err) {
                        alert(err);
                    });
                    var f = peer.connect(requestedPeer, {
                        label: 'file',
                        reliable: true
                    });
                    f.on('open', function () {
                        connect(f);
                    });
                    f.on('error', function (err) {
                        alert(err);
                    });
                }
                connectedPeers[requestedPeer] = 1;


                $('#chatbox-section').removeClass('d-none');
                $('#camera-section').removeClass('d-none');




                $.each(db.users, function (key, value) {
                    if (value.username == requestedPeer) {
                        $('.text-header').html("<p>" + value.nombre + " " + value.apellido +
                            "<br><small></small></p>");
                        $('#user-camera').html(value.nombre + " " + value.apellido);
                        $('#info-name').html(value.nombre + " " + value.apellido);
                        $('#info-username').html(value.username);
                        $('#info-image').prop("src", value.imagen);
                    }
                });

                $('#messages-section').html("");

                $.each(db.conversations, function (key, value) {
                    if (value.connections_id == conversation_id) {
                        $.each(value.messages, function (key1, value1) {
                            if (value1.from == username) {
                                $('#messages-section').append(
                                    "<div class='border border-secondary rounded me'>" +
                                    value1.message +
                                    "</div>");
                            } else {
                                $('#messages-section').append(
                                    "<div class='border border-secondary rounded'>" +
                                    value1.message +
                                    "</div>");
                            }
                        });
                    }
                });



            });



            $('#close').click(function () {
                eachActiveConnection(function (c) {
                    c.close();
                });
            });

            // Esta funcion se ejecuta al hacer click sobre el boton enviar
            $('#send').submit(function (e) {

                e.preventDefault();

                var msg = $('#message-text').val();
                eachActiveConnection(function (c, $c) {
                    if (c.label === 'chat') {
                        console.log($c);
                        c.send(msg);



                        $.each(db.conversations, function (key, value) {
                            if (value.connections_id == c.metadata.conversation_id) {
                                var obj = {
                                    from: username,
                                    message: msg
                                };
                                db.conversations[key].messages.push(obj);
                            }
                        });


                        $('#messages-section').append(
                            "<div class='border border-secondary rounded me'>" + msg +
                            "</div>");
                    }
                });
                $('#message-text').val('');
                $('#message-text').focus();
            });

            $('#message-text').on('keypress', function (e) {
                if (e.which === 13) {

                    $(this).attr("disabled", "disabled");

                    var msg = $('#message-text').val();
                    eachActiveConnection(function (c, $c) {
                        if (c.label === 'chat') {
                            console.log($c);
                            c.send(msg);



                            $.each(db.conversations, function (key, value) {
                                if (value.connections_id == c.metadata.conversation_id) {
                                    var obj = {
                                        from: username,
                                        message: msg
                                    };
                                    db.conversations[key].messages.push(obj);
                                }
                            });


                            $('#messages-section').append(
                                "<div class='border border-secondary rounded me'>" + msg +
                                "</div>");
                        }
                    });
                    $('#message-text').val('');
                    $('#message-text').focus();

                    $(this).removeAttr("disabled");
                }
            });

            $("#call").click(function () {
                $("#hangup").prop("disabled", false);
                $("#call").prop("disabled", true);
                eachActiveConnection(function (c, $c) {
                    var call = peer.call(c.peer, window.localStream);
                    call.on('stream', function (stream) {
                        window.peer_stream = stream;
                        onReceiveStream(stream, 'peer-camera');
                        $('#camera').removeClass('d-none');
                        $('#info').addClass('d-none');
                    });

                    $("#hangup").click(function () {
                        call.close();
                        $("#hangup").prop("disabled", true);
                        $("#call").prop("disabled", false);
                        $('#camera').addClass('d-none');
                        $('#info').removeClass('d-none');
                    });
                });
            });

            // Esta funcion controla el envio de datos a todas las conexiones activas
            function eachActiveConnection(fn) {
                var actives = $('.active');
                var checkedIds = {};
                actives.each(function () {
                    var peerId = $(this).attr('id');
                    if (!checkedIds[peerId]) {
                        var conns = peer.connections[peerId];
                        for (var i = 0, ii = conns.length; i < ii; i += 1) {
                            var conn = conns[i];
                            fn(conn, $(this));
                        }
                    }
                    checkedIds[peerId] = 1;
                });
            }

            // Solicitar mostrar mi camara
            requestLocalVideo({
                success: function (stream) {
                    window.localStream = stream;
                    onReceiveStream(stream, 'my-camera');
                },
                error: function (err) {
                    alert("Cannot get access to your camera and video !");
                    console.error(err);
                }
            });
        });

        // Esta funcion se ejecuta antes de cerrar el navegador destruyendo la conexion del usuario en el servidor de PeerJS
        window.onunload = window.onbeforeunload = function (e) {
            if (!!peer && !peer.destroyed) {
                peer.destroy();
            }
        };

        function requestLocalVideo(callbacks) {
            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
            navigator.getUserMedia({
                audio: true,
                video: true
            }, callbacks.success, callbacks.error);
        }

        function onReceiveStream(stream, element_id) {
            var video = document.getElementById(element_id);
            video.src = window.URL.createObjectURL(stream);
            window.peer_stream = stream;
        }
    </script>
</body>

</html>